# SRS: Trusted Environment Bootstrap (RISC-V) — bootstrap
**Версия:** 0.1 
**Дата:** 2025-10-19  
**Автор:** Даниил Смолин

---

## 1. Введение

### 1.1 Цель документа
Этот документ описывает требования к системе «bootstrap» — набору инструментов и артефактов для воспроизводимого и максимально доверенного начального загрузочного пути (bootstrap) под архитектуру RISC‑V, включая сборку первых стадий, генерацию образов и запуск в QEMU/на железе.

### 1.2 Область применения
SRS охватывает функциональные и нефункциональные требования к:
- Builder-пайплайну (на момент версии 0.1 stage1, далее планируется stage2);
- Генерации образов (ELF → BIN, прошивки, memory map);
- Средам запуска (QEMU virt, Lichee Pi 4A и т.п.);
- Верификации (тесты, хеши, воспроизводимость);
- Документации и UX (CLI, логи, артефакты сборки).

### 1.3 Определения и сокращения
- **Bootstrap** — процесс построения минимальной доверенной основы инструментов/ПО «из ничего/минимума».
- **Stage-N** — нумерованная стадия цепочки сборки (stage1 собирает stage2 и т.д.).
- **TE (Trusted Environment)** — доверенная среда выполнения/сборки.
- **QEMU** — эмулятор архитектур, используемый для тестирования.
- **ELF** — Executable and Linkable Format.
- **HEX0/…** — минималистичные форматы/инструменты для ранних стадий.

---

## 2. Заинтересованные стороны
- **Студенты‑разработчики:** реализуют и поддерживают пайплайн, воспроизводит результаты, вносят улучшения.
- **Преподаватели/наставники:** проверяют требования, приёмку.

---

## 3. Описание системы

### 3.1 Контекст
Система строит доверенную цепочку инструментов и артефактов, позволяя:
1) собрать ранние стадии минимальными средствами;
2) собрать более высокоуровневые инструменты;
3) собрать целевой образ и запустить его (QEMU/железо).

### 3.2 Ограничения и допущения
- Ориентир: RISC‑V 64-bit (rv64).
- Разрешается использование только согласованного набора внешних инструментов на ранних стадиях `riscv64-unknown-elf-gcc vZ`.
- Воспроизводимость сборки — обязательна (фиксированные версии/хеши).

---

## 4. Пользовательские сценарии (Use Cases)

### UC‑01: Быстрая локальная сборка и запуск в QEMU
**Актор:** разработчик  
**Цель:** получить образ и убедиться, что ранние стадии инициализируются.  
**Основной поток:**
1. Запустить `make qemu`.
2. Система собирает стадии, формирует ELF/BIN.
3. Запускается QEMU; в консоли наблюдаются загрузочные логи.  
**Критерии приёмки:** команда завершается без ошибок.

### UC‑02: Проверка воспроизводимости сборки
**Актор:** преподаватель/CI  
**Цель:** две сборки подряд дают идентичные хеши артефактов.  
**Критерии приёмки:** SHA256 всех ключевых артефактов совпадает.

---

## 5. Функциональные требования (FR)

**Правила нумерации:** `BLD‑REQ‑###` — сборка/pipeline; `IMG‑REQ‑###` — образы/форматы; `RUN‑REQ‑###` — запуск/платформы; `VER‑REQ‑###` — верификация/тесты; `DOC‑REQ‑###` — документация/UX.

### 5.1 Сборка/пайплайн
- **BLD‑REQ‑001:** Система должна предоставлять цель `make all`, выполняющую полный цикл: stage1 → stage2 → toolchain subset → образ.

### 5.2 Образы и форматы
- **IMG‑REQ‑001:** Система должна уметь конвертировать ELF в BIN с фиксированной entry‑точкой `0x08048000`.
- **IMG‑REQ‑002:** Должен быть документирован memory map (сегменты, адреса, выравнивание).

### 5.3 Запуск
- **RUN‑REQ‑001:** Команда `make qemu` должна запускать образ на `qemu-system-riscv64 -machine virt -bios` с консолью UART0.
- **RUN‑REQ‑002:** (Опционально) Поддержать генерацию payload для Lichee Pi 4A.

### 5.4 Документация и UX
- **DOC‑REQ‑001:** README должен содержать «5‑минутный старт»: зависимости, `make all`, `make qemu`.
- **DOC‑REQ‑002:** Каждая стадия должна иметь краткую страницу: цель, входы/выходы, критерии готовности.

---

## 6. Нефункциональные требования (NFR)

### 6.1 Производительность
- **NFR‑PERF‑001:** Полная сборка для QEMU должна укладываться в не более чем 1 минуту на машине с 4 ядрами и 8 ГБ RAM.

### 6.2 Надёжность/воспроизводимость
- **NFR‑REP‑001:** Две последовательные сборки в чистом окружении дают идентичные SHA256 для ключевых артефактов.
- **NFR‑LOG‑001:** Все ошибки сборки сопровождаются кодом и ссылкой на стадию.

### 6.3 Портируемость
- **NFR‑PORT‑001:** Поддержка Linux x86_64, WSL2.

### 6.4 Безопасность/доверие
- **NFR‑SEC‑001:** Список внешних бинарных зависимостей должен быть минимален и зафиксирован (версии/хеши).

---

## 7. Интерфейсы

### 7.1 CLI
- `make all | clean | qemu | verify | hashes`  
- Ключи окружения: `CROSS_COMPILE`, `RISCV_PREFIX`, `PLATFORM=qemu|lpi4a` и т.п.

### 7.2 Форматы файлов
- ELF (вход), BIN (выход), MAP (карта), LOG (журналы).
- Таблица соответствий: сегмент → адрес → размер (см. Приложение A).

### 7.3 Аппаратные/эмуляторные
- QEMU virt: UART0 @115200 8N1; память — 128 мб.

---

## 8. Критерии приёмки

- Выполнены все FR/NFR, пройдены UC‑01, UC‑02.  
- README проверен «чистой» машиной (роль рецензента).  
- Хеши артефактов стабильны на двух независимых хостах.

---

## 9. Риски и допущения
- Риск: различия версий QEMU/линкеров → отход хешей.  
- Митигирующие меры: lock‑файлы версий/контейнер.  
- Допущение: доступен минимальный кросс‑компилятор Предполагается наличие riscv64-unknown-elf-gcc. Stage0 в рамках проекта не реализуется.

---

## 10. План релизов и метрики готовности
- **M1:** Базовый builder + `make qemu`.  
- **M2:** Документированный memory map + verify‑хеши.  
- **M3:** запуск на Lichee Pi 4A после отладки QEMU.  
- Метрики: % покрытых FR, стабильность хешей, время сборки.

---

## Приложение A. Memory Map (основано на архитектуре целевого проекта)

| Диапазон адресов              | Назначение                                         | Объём (примерно) | Примечание |
|------------------------------|----------------------------------------------------|------------------|------------|
| `0x54000000 - 0xBBFFFFFF`     | Файлы (files)                                      | ~1744 MB         | Содержимое файловой системы |
| `0x30000000 - 0x53FFFFFF`     | Сохранённые процессы (saved processes)             | ~604 MB          | Хранение памяти завершённых процессов |
| `0x08048000 - 0x2FFFFFFF`     | Текущий процесс (current running process)          | ~670 MB          | Код/данные выполняемого процесса; точка входа `.text` = `0x08048000` |
| `0x01080000 - 0x08000000`     | 32-битный стек                                     | ~117 MB          | Используется ранним процессом |
| `0x01000010 - 0x0107FFFF`     | Таблица файловых дескрипторов (16 байт × 32K)     | ~512 KB          | `{ unused, address, length, unused }` |
| `0x01000000 - 0x0100000F`     | Дескриптор stdin (disk locator)                   | 16 байт          | `{ sector (4B), offset (2B), unused }` |
| `0x201800 - 0xFFFFFF`         | Имена файлов (file names 6..14335)                | До ~16K имён     | Глобальные дескрипторы файлов |
| `0x201400 - 0x2017FF`         | Имя файла дескриптора №5                          | 1 имя            | |
| `0x201000 - 0x2013FF`         | Имя файла дескриптора №4                          | 1 имя            | |
| `0x200C00 - 0x200FFF`         | Имя файла дескриптора №3 (`"/e820"`)              | 1 имя            | Содержит часть BIOS-информации |
| `0x100000 - 0x200BF0`         | Не используется                                   | -                | Зарезервировано |
| `0x080000 - 0x0FFFFF`         | BIOS                                              | ~512 KB          | BIOS-код |
| `0x050000 - 0x07FFFF`         | Scratch buffer                                    | ~192 KB          | Хранение абсолютного пути файла |
| `0x040000 - 0x04FFFF`         | Буфер устройства stdin                            | ~64 KB           | |
| `0x020000 - 0x03FFFF`         | Описатели процессов (16 * 4096 байт каждый)       | ~128 KB          | Структуры: адрес процесса, brk, стек, файловые дескрипторы и т.д. |
| `0x010800 - 0x01FFFF`         | BIOS memory map                                   | ~56 KB           | |
| `0x010000 - 0x0107FF`         | Таблица прерываний                                | 2 KB             | Interrupt vector table |
| `0x008E00 - 0x00FFFF`         | Не используется                                   | -                | |
| `0x007C00 - 0x008DFF`         | Код (bootloader/code)                             | ~5 KB            | Начальный загрузочный код |
| `0x007B00 - 0x007BFF`         | Сохранённые 32-битные регистры (в 16-битном режиме) | 256 байт      | |
| `< 0x007B00`                  | Стек реального режима (real mode stack)           | -                | Используется до перехода в защищённый режим |

## Приложение B. Сигнатуры логов (шаблон)
- Stage1 OK\n
- ENTER MAIN\n

---

### Руководство по сопровождению SRS
- Все требования **атомарны**, **проверяемы**, имеют **ID** и критерии приёмки.
- Изменения оформляются через PR с ссылкой на тест/скрипт проверки.
